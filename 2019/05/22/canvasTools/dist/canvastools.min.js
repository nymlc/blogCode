/*!
 * CanvasTools v1.0.0 
 * (github)https://github.com/S-mohan/canvasTools
 * (url) https://smohan.net/lab/canvastools
 * (c) smohan <https://smohan.net>
 * license MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("CanvasTools",[],e):"object"==typeof exports?exports.CanvasTools=e():t.CanvasTools=e()}(this,function(){return function(t){function e(a){if(n[a])return n[a].exports;var o=n[a]={i:a,l:!1,exports:{}};return t[a].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,a){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=4)}([function(t,e,n){"use strict";window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,n=(this.document||this.ownerDocument).querySelectorAll(t),a=this;do{for(e=n.length;--e>=0&&n.item(e)!==a;);}while(e<0&&(a=a.parentElement));return a})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a={rect:{panel:"stroke",name:"矩形工具"},ellipse:{panel:"stroke",name:"椭圆工具"},brush:{panel:"stroke",name:"画笔工具"},arrow:{panel:"stroke",name:"箭头工具"},mosaic:{panel:"mosaic",name:"马赛克工具"},font:{panel:"font",name:"文字工具"},rubber:{name:"橡皮擦"},undo:{name:"撤销操作"},resume:{name:"恢复操作"},save:{name:"保存"}},o=["#000000","#808080","#800000","#f7883a","#308430","#385ad3","#800080","#009999","#ffffff","#c0c0c0","#fb3838","#ffff00","#99cc00","#3894e4","#f31bf3","#16dcdc"],i=[12,14,16,18,20,22],s=[2,4,6],r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];for(var n in a)if(function(e){return t&&!!~t.indexOf(e)}(n)){var o=a[n];e.push('<div class="canvas-tools-btn js-btn" data-panel="'+(o.panel||"")+'" data-value="'+n+'" data-action="" title="'+o.name+'">\n\t\t\t<a class="btn-toggle"><i class="canvas-tools-icon__'+n+'"></i></a>\n\t\t\t</div>')}return e.join("")},l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#fb3838",e="";e+='<div class="colors">',e+='<span class="color-selected"><i class="js-color-selected" style="background:'+t+'"></i></span>',e+='<div class="color-list">';for(var n=[],a=[],i=0;i<16;i++){var s='<li class="js-color" style="background:'+o[i]+'" data-value="'+o[i]+'"></li>';i<8?n.push(s):a.push(s)}return e+="<ul>"+n.join("")+"</ul>",e+="<ul>"+a.join("")+"</ul>",e+="</div>",e+="</div>"},c=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e='<div class="strokes">',n=0,a=s.length;n<a;n++){var o=s[n],i=["stroke","js-stroke-width"];o===t&&i.push("active"),e+='<a class="'+i.join(" ")+'" data-value="'+o+'"><i style="width:'+(o+1)+"px;height:"+(o+1)+'px;"></i></a>'}return e+="</div>"},u=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,e='<select class="font-select js-font-size">',n=0,a=i.length;n<a;n++){var o=i[n];e+='<option value="'+o+'" '+(o===t?"selected":"")+">"+o+"</option>"}return e+="</select>"},h=function(){return'<label class="ambiguite-range"><span>模糊度</span><input type="range" min="0" step="0.01" max="1" value="'+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5)+'" class="js-mosaic-ambiguity"></label>'};e.default={getButtons:r,getColorPanel:l,getStrokePanel:c,getFontPanel:u,getAmbiguity:h},t.exports=e.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=Array.prototype,i={id:/^#([\w-]+)$/,className:/^\.([\w-]+)$/,tagName:/^[\w-]+$/},s=function(t){return"[object Object]"===Object.prototype.toString.call(t)},r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;if("string"==typeof t){t=t.trim();var n=[];return i.id.test(t)?(n=document.getElementById(RegExp.$1),n=n?[n]:[]):n=i.className.test(t)?e.getElementsByClassName(RegExp.$1):i.tagName.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t),o.slice.call(n)}return[]},l=function(t,e){if("object"===(void 0===t?"undefined":a(t))&&"function"==typeof e)if(Array.isArray(t))for(var n=0,o=t.length;n<o&&!1!==e.call(t[n],n,t[n]);n++);else if("length"in t&&"number"==typeof t.length)for(var i in t)if(!1===e.call(t[i],i,t[i]))break},c=function(t,e,n,a){var i=void 0,s=void 0;if("function"==typeof n)s=n;else{if("string"!=typeof n||"function"!=typeof a)return;i=n}i&&(s=function(e){for(var n=r(i,t),s=!1,l=0,c=n.length;l<c;l++){var u=n[l];if(u===e.target||u.contains(e.target)){s=u;break}}s&&a.apply(s,o.slice.call(arguments))}),t.addEventListener(e,s,!1)},u=function(t,e,n){return t.removeEventListener(e,n,!1)},h=function(t){return t.ownerDocument.defaultView.getComputedStyle(t,null)},f=function t(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=1,a=arguments.length;n<a;n++){var o=arguments[n];if(o&&Object.keys(o).length)for(var i in o)o.hasOwnProperty(i)&&(s(o[i])?e[i]=t(e[i],o[i]):e[i]=o[i])}return e},d=function(t,e,n,a){Array.isArray(t)||(t=[t]),l(t,function(t,o){return c(o,e,n,a)})},g=function(t,e,n){Array.isArray(t)||(t=[t]),l(t,function(t,a){return u(a,e,n)})},p=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"add",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";Array.isArray(t)||(t=[t]),l(t,function(t,a){return a.classList[e](n)})};e.default={$:r,each:l,bind:c,extend:f,unbind:u,getComputedStyles:h,classList:p,$on:d,$off:g},t.exports=e.default},function(t,e){},function(t,e,n){"use strict";function a(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(){var t=this,e=this.canvas,n=this.context,a=this.$el,o=this.state,i=(this.config,this.rect),g=this._handles,p=this.history,m=(this.historyIndex,v.default.$(".js-btn",a)),y=v.default.$(".js-panel__font",a)[0],x=v.default.$(".js-panel__stroke",a)[0],w=v.default.$(".js-panel__mosaic",a)[0],k=v.default.$(".js-color-selected",a),T=v.default.$(".js-color",a),$=v.default.$(".js-stroke-width",a),j=v.default.$(".js-font-size",a),_=v.default.$(".js-mosaic-ambiguity",a);g.btnEmit=function(e){var a=this;e.stopPropagation(),"font"===o.drawType&&u.call(t,e);var s=this.getAttribute("data-panel"),r=this.getAttribute("data-value");if(v.default.each(m,function(t,e){e!==a&&v.default.classList(e,"remove","active")}),~b.indexOf(r)&&(o.drawType=r),s){v.default.classList(this,"toggle","active");var l=/active/.test(this.className),c=l?"block":"none";"stroke"===s?(y.style.display="none",w.style.display="none",x.style.display=c):"font"===s?(y.style.display=c,x.style.display="none",w.style.display="none"):"mosaic"===s&&(w.style.display=c,y.style.display="none",x.style.display="none")}if("save"===r)return void N.call(t);"undo"===r&&p.length>1&&t.historyIndex>0&&(t.historyIndex--,n.putImageData(p[t.historyIndex],0,0,0,0,i.width,i.height)),"resume"===r&&p.length>1&&t.historyIndex<p.length-1&&(t.historyIndex++,n.putImageData(p[t.historyIndex],0,0,0,0,i.width,i.height)),f.call(t)},g.toggleColor=function(t){var e=this.getAttribute("data-value");o.strokeColor=e,v.default.each(k,function(t,n){return n.style.background=e})},g.toggleStrokeWidth=function(t){o.strokeWidth=Number(this.getAttribute("data-value")),v.default.each($,function(t,e){var n=Number(e.getAttribute("data-value")),a=n===o.strokeWidth?"add":"remove";v.default.classList(e,a,"active")})},g.toggleFontSize=function(t){o.fontSize=Number(this.value)};var M=void 0;g.onMouseDown=function(e){if(!1!=!!~b.indexOf(o.drawType)&&"font"!==o.drawType&&"drag"!==o.drawType){switch(M=A(e,i),o.lastImageData=n.getImageData(0,0,i.width,i.height),n.lineCap="round",n.lineJoin="round",n.shadowBlur=0,n.strokeStyle=o.strokeColor,n.lineWidth=o.strokeWidth,o.drawType){case"rect":s.call(t,e,M);break;case"ellipse":r.call(t,e,M);break;case"mosaic":h.call(t,e);break;case"arrow":c.call(t,e,M);break;case"brush":default:l.call(t,e,M)}v.default.$on(document,"mousemove",g.onMouseMove),v.default.$on(document,"mouseup",g.onMouseUp)}},g.onMouseMove=function(e){if(!1!=!!~b.indexOf(o.drawType)&&"font"!==o.drawType)switch(o.drawType){case"rect":s.call(t,e,M);break;case"ellipse":r.call(t,e,M);break;case"mosaic":h.call(t,e);break;case"arrow":c.call(t,e,null);break;case"brush":default:l.call(t,e,null)}},g.onMouseUp=function(e){v.default.$off(document,"mousemove",g.onMouseMove),v.default.$off(document,"mouseup",g.onMouseUp),~b.indexOf(o.drawType)&&"font"!==o.drawType&&d.call(t)},g.insertTextHelper=function(e){if(e.stopPropagation(),"font"===o.drawType){if(o.isEntry)return void u.call(t,e);S(e,o,i),o.isEntry=!0}},g.removeTextHelper=function(e){"font"!==o.drawType?P():e.target.closest("#canvas-tools-input")||u.call(t,e)},g.resize=function(n){var a=e.getBoundingClientRect();i.width=e.width,i.height=e.height,i.offsetWidth=e.offsetWidth,i.offsetHeight=e.offsetHeight,i.top=a.top,i.left=a.left,"font"===o.drawType&&o.isEntry&&u.call(t,n)},g.toggleAmbiguity=function(t){o.ambiguity=this.value,console.log(o)},v.default.$on(m,"click",g.btnEmit),v.default.$on(T,"click",g.toggleColor),v.default.$on($,"click",g.toggleStrokeWidth),v.default.$on(j,"change",g.toggleFontSize),v.default.$on(_,"change",g.toggleAmbiguity),v.default.$on(e,"mousedown",g.onMouseDown),v.default.$on(e,"click",g.insertTextHelper),v.default.$on(document,"click",g.removeTextHelper),window.addEventListener("resize",g.resize)}function s(t,e){var n=this.context,a=this.rect,o=this.state,i=A(t,a),s=i.x-e.x,r=i.y-e.y;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save(),n.beginPath(),n.strokeRect(e.x,e.y,s,r),n.restore(),n.closePath()}function r(t,e){var n=this.context,a=this.rect,o=this.state,i=A(t,a),s=(i.x-e.x)/2*1,r=(i.y-e.y)/2*1,l=e.x/s+1,c=e.y/r+1;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save(),n.beginPath(),n.scale(s,r),n.arc(l,c,1,0,2*Math.PI),n.restore(),n.closePath(),n.stroke()}function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.context,a=this.rect;if(e)n.beginPath(),n.moveTo(e.x,e.y);else{var o=A(t,a);n.lineTo(o.x,o.y),n.stroke()}}function c(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e)B=e.x,O=e.y;else{var n=this.context,a=this.rect,o=this.state,i=A(t,a),s=i.x,r=i.y;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save();var l=180*Math.atan2(O-r,B-s)/Math.PI,c=(l+30)*Math.PI/180,u=(l-30)*Math.PI/180,h=20*Math.cos(c),f=20*Math.sin(c),d=20*Math.cos(u),g=20*Math.sin(u);n.beginPath();var p=B-h,v=O-f;n.moveTo(p,v),n.moveTo(B,O),n.lineTo(s,r),p=s+h,v=r+f,n.moveTo(p,v),n.lineTo(s,r),p=s+d,v=r+g,n.lineTo(p,v),n.stroke(),n.restore()}}function u(t){var e=document.getElementById(T);if(!e)return void(this.state.isEntry=!1);var n=e.textContent.trim(),a=n.length;if(!n||!a)return this.state.isEntry=!1,void P();var o=v.default.getComputedStyles(e),i=this.state.fontSize||$,s=2*k,r=this.context,l=parseFloat(o.left)-this.rect.left+s-2,c=parseFloat(o.top)-this.rect.top+i,u=0,h=0;r.beginPath(),r.save(),r.fillStyle=this.state.strokeColor,r.font=this.state.fontSize+"px "+j;for(var f=0;f<a;f++){var g=n[f];u+=r.measureText(g).width,u>this.rect.width-l&&(r.fillText(n.substring(h,f),l,c),c+=i,u=0,h=f),f==a-1&&r.fillText(n.substring(h,f+1),l,c)}r.restore(),r.closePath(),this.state.isEntry=!1,P(),d.call(this)}function h(t){for(var e=this.context,n=this.state,a=this.rect,o=A(t,a),i=3*n.strokeWidth,s=e.getImageData(o.x,o.y,i,i).data,r=0,l=0,c=0,u=0;u<i;u++)for(var h=0;h<i;h++)r+=s[4*(i*u+h)],l+=s[4*(i*u+h)+1],c+=s[4*(i*u+h)+2];r=Math.round(r/(i*i)),l=Math.round(l/(i*i)),c=Math.round(c/(i*i));var f="rgba("+r+", "+l+", "+c+", "+n.ambiguity+")";e.beginPath(),e.save(),e.fillStyle=f,e.fillRect(o.x,o.y,i,i),e.restore()}function f(){var t=this.canvas,e=void 0;switch(this.state.drawType){case"brush":e="brush";break;case"font":e="font";break;case"mosaic":e="mosaic";break;case"rect":case"ellipse":e="crosshair";break;case"drag":e="drag";break;default:e="default"}e&&(t.className=t.className.replace(/canvas-cursor__(\w+)/,"").trim()+" canvas-cursor__"+e)}function d(){this.history.length-1>this.historyIndex&&this.history.splice(this.historyIndex+1,this.history.length),this.historyIndex++,this.history.push(this.context.getImageData(0,0,this.rect.width,this.rect.height))}Object.defineProperty(e,"__esModule",{value:!0});var g=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}();n(3),n(0);var p=n(2),v=a(p),m=n(1),y=a(m),b=["rect","ellipse","brush","arrow","mosaic","font","rubber"],x="#fb3838",w=2,k=2,T="canvas-tools_text_helper",$=12,j='"Helvetica Neue",Helvetica,Arial,"Hiragino Sans GB","Hiragino Sans GB W3","WenQuanYi Micro Hei",sans-serif',_=.7,M=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__stroke",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=y.default.getStrokePanel(t)+y.default.getColorPanel(e),n},E=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:x,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__font",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=y.default.getFontPanel(t)+y.default.getColorPanel(e),n},C=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:x,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__mosaic",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=y.default.getStrokePanel(t)+y.default.getAmbiguity(e),n},I=function(){var t=document.getElementById(T);return t||(t=document.createElement("div"),t.setAttribute("contenteditable","plaintext-only"),t.setAttribute("spellcheck","false"),t.setAttribute("id",T),t.className=T,document.body.appendChild(t)),t.innerHTML="",t.style.cssText="display: block",t},S=function(t,e,n){var a=I(),o=e.fontSize||$,i=2*k+2,s=A(t,n),r=t.pageX,l=t.pageY,c=Math.floor(n.width-s.x)-i,u=Math.floor(n.height-s.y)-i;c<=o&&(r-=o+i-c,c=o),u<=o&&(l-=o+i-u,u=o),c>=n.width&&(c=n.width-s.x),u>=n.height&&(u=n.height-s.y);var h={"font-size":o+"px","line-height":o+"px","min-width":o+"px","min-height":o+"px","max-width":c+"px","max-height":u+"px","z-index":1990,"font-family":j,display:"block",position:"absolute",top:l+"px",left:r+"px",color:e.strokeColor,padding:k+"px",overflow:"hidden"},f="";for(var d in h)f+=d+":"+h[d]+";";return a.style.cssText=f,a.focus(),a},P=function(){var t=document.getElementById(T);t&&(t.innerHTML="",t.style.cssText="display: none")},A=function(t,e){var n=t.pageX-e.left,a=t.pageY-e.top;return n<=0&&(n=0),n>=e.width&&(n=e.width),a<=0&&(a=0),a>=e.height&&(a=e.height),{x:n,y:a}},D={container:document.body,buttons:["rect","ellipse","brush","arrow","font","mosaic","undo","drag","resume","save"]},H=document.createElementNS("http://www.w3.org/1999/xhtml","a"),z="download"in H,N=function(){var t="canvas_"+Date.now()+".png",e=this.canvas;if(z){var n=e.toDataURL("png");n=n.replace("image/png","image/octet-stream"),setTimeout(function(){H.href=n,H.download=t,H.dispatchEvent(new MouseEvent("click"))})}else"undefined"!=typeof navigator&&"function"==typeof e.msToBlob&&navigator.msSaveBlob?navigator.msSaveBlob(e.msToBlob(),t):console.log("您的浏览器不支持该操作")},B=0,O=0,W=function(){function t(e,n){if(o(this,t),!e||"function"!=typeof e.getContext)throw new Error("invalid canvas object");this.canvas=e,this.context=e.getContext("2d"),this.config=v.default.extend({},D,n||{}),this.history=[],this.historyIndex=-1,this.state=Object.create(null),this.rect=Object.create(null),this._handles=Object.create(null),this.state.strokeWidth=w,this.state.fontSize=$,this.state.strokeColor=x,this.state.ambiguity=_,this.state.drawType="drag",this.state.isEntry=!1,this.rect.width=e.width,this.rect.height=e.height,this.rect.offsetWidth=e.offsetWidth,this.rect.offsetHeight=e.offsetHeight;var a=e.getBoundingClientRect();this.rect.top=a.top,this.rect.left=a.left,this.state.lastImageData=this.context.getImageData(0,0,this.rect.width,this.rect.height),d.call(this),f.call(this),this.render()}return g(t,[{key:"render",value:function(){var t=this.config,e=this.state,n=document.createElement("div");n.className="canvas-tools",n.innerHTML=y.default.getButtons(t.buttons),t.container.appendChild(n),this.$el=n,this.$el.appendChild(M(e.strokeWidth,e.strokeColor)),this.$el.appendChild(E(e.fontSize,e.strokeColor)),this.$el.appendChild(C(e.strokeWidth,e.ambiguity)),i.call(this)}},{key:"refresh",value:function(){}},{key:"destory",value:function(){var t=this.canvas,e=this.$el,n=this._handles,a=v.default.$(".js-btn",e),o=v.default.$(".js-color",e),i=v.default.$(".js-stroke-width",e),s=v.default.$(".js-font-size",e),r=v.default.$(".js-mosaic-ambiguity",e),l=document.getElementById(T);v.default.$off(a,"click",n.btnEmit),v.default.$off(o,"click",n.toggleColor),v.default.$off(i,"click",n.toggleStrokeWidth),v.default.$off(s,"change",n.toggleFontSize),v.default.$off(r,"change",n.toggleAmbiguity),v.default.$off(t,"mousedown",n.onMouseDown),v.default.$off(t,"click",n.insertTextHelper),v.default.$off(document,"click",n.removeTextHelper),window.removeEventListener("resize",n.resize),l&&l.parentNoed.removeChild(l),this.canvas=null,this.context=null,this.history.length=0,this.historyIndex=-1,this.config.container.removeChild(this.$el)}},{key:"refreshSize",value:function(t,e,n,a){if(!t||"function"!=typeof t.getContext)throw new Error("invalid canvas object");this.canvas=t,this.context=t.getContext("2d"),this.rect.width=t.width,this.rect.height=t.height,this.rect.offsetWidth=t.offsetWidth,this.rect.offsetHeight=t.offsetHeight,this.hmovex=e,this.hmovey=n;var o=t.getBoundingClientRect();this.rect.top=o.top,this.rect.left=o.left,a&&(this.state.drawType="drag",this.bound={minX:0,maxX:0,minY:0,maxY:0}),this.state.lastImageData=this.context.getImageData(0,0,this.rect.width,this.rect.height),this.history.length=0,d.call(this),f.call(this),__refreshDrawHistory.call(this)}}]),t}();e.default=W,t.exports=e.default}])});